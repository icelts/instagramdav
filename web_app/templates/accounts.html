{% extends "base.html" %}

{% block title %}账号管理 - Instagram Clone{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-user-shield"></i> Instagram账号管理
        </h1>
    </div>
</div>

<!-- 添加账号表单 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus-circle"></i> 添加Instagram账号</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_account') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名 *</label>
                                <input type="text" class="form-control" id="username" name="username" 
                                       placeholder="输入Instagram用户名" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">密码 *</label>
                                <input type="password" class="form-control" id="password" name="password" 
                                       placeholder="输入Instagram密码" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="proxy" class="form-label">代理地址</label>
                        <input type="text" class="form-control" id="proxy" name="proxy" 
                               placeholder="例如: http://proxy.server:port 或 http://username:password@proxy.server:port">
                        <div class="form-text">可选，如果需要使用代理请填写</div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 添加账号
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 统计信息 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> 账号统计</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h3 class="text-primary" id="total-accounts">-</h3>
                    <small class="text-muted">总账号数</small>
                </div>
                <div class="text-center mb-3">
                    <h3 class="text-success" id="active-accounts">-</h3>
                    <small class="text-muted">活跃账号</small>
                </div>
                <div class="text-center">
                    <h3 class="text-danger" id="inactive-accounts">-</h3>
                    <small class="text-muted">禁用账号</small>
                </div>
            </div>
        </div>
        
        <!-- 使用说明 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> 使用说明</h6>
            </div>
            <div class="card-body">
                <ul class="small">
                    <li>支持HTTP/HTTPS代理</li>
                    <li>代理格式: http://host:port</li>
                    <li>认证代理: http://user:pass@host:port</li>
                    <li>建议使用多个账号轮换</li>
                    <li>账号会自动保存session</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 账号列表 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> 账号列表</h5>
                <div>
                    <a href="{{ url_for('admin') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-arrow-left"></i> 返回管理
                    </a>
                    <button class="btn btn-outline-success btn-sm" onclick="loadAccountsFromConfig()">
                        <i class="fas fa-download"></i> 从配置加载
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if accounts %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>用户名</th>
                                <th>代理</th>
                                <th>状态</th>
                                <th>最后使用</th>
                                <th>Session状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in accounts %}
                            <tr>
                                <td class="fw-bold">{{ account.username }}</td>
                                <td>
                                    {% if account.proxy %}
                                        <span class="badge bg-info" title="{{ account.proxy }}">
                                            <i class="fas fa-server"></i> 使用代理
                                        </span>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-globe"></i> 直连
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.is_active %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> 活跃
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times-circle"></i> 禁用
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.last_used %}
                                        <small>
                                            {{ account.last_used.strftime('%Y-%m-%d %H:%M') }}
                                        </small>
                                    {% else %}
                                        <span class="text-muted">未使用</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.session_data %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-key"></i> 已保存
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-clock"></i> 无session
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="testAccount('{{ account.id }}')"
                                                title="测试连接">
                                            <i class="fas fa-plug"></i>
                                        </button>
                                        <a href="{{ url_for('remove_account', account_id=account.id) }}" 
                                           class="btn btn-outline-danger"
                                           onclick="return confirm('确定要删除账号 {{ account.username }} 吗？\n\n注意：删除后相关的session信息也会丢失！')" 
                                           title="删除">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-shield fa-4x text-muted mb-4"></i>
                    <h4 class="text-muted">还没有配置Instagram账号</h4>
                    <p class="text-muted mb-4">请添加Instagram账号以开始数据采集</p>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb"></i> 提示</h6>
                                <p class="mb-2">你可以：</p>
                                <ul class="text-start">
                                    <li>使用上方表单手动添加账号</li>
                                    <li>在环境变量中配置账号信息</li>
                                    <li>点击"从配置加载"按钮</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadAccountStats();
    setInterval(loadAccountStats, 30000);
});

function loadAccountStats() {
    $.get('/api/stats', function(data) {
        $('#total-accounts').text(data.accounts_count);
        $('#active-accounts').text(data.active_accounts_count);
        $('#inactive-accounts').text(data.accounts_count - data.active_accounts_count);
    });
}

function loadAccountsFromConfig() {
    if (confirm('确定要从环境配置中加载Instagram账号吗？\n\n这会覆盖现有账号信息。')) {
        window.location.href = '{{ url_for("load_instagram_accounts") }}';
    }
}

function testAccount(accountId) {
    // 这里可以添加测试账号连接的功能
    alert('账号测试功能待实现');
}
</script>
{% endblock %}
