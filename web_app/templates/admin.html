{% extends "base.html" %}
{% block content %}
<div class="toolbar">
  <div class="brand">
    <div class="dot"></div>
    <div>
      <div>ç®¡ç†é¢æ¿</div>
      <small class="muted">é‡‡é›†è´¦å· Â· ä»£ç† Â· ç›®æ ‡ç”¨æˆ· Â· è°ƒåº¦é—´éš”</small>
    </div>
  </div>
  <div class="toolbar-actions">
    <div class="badge">â±ï¸ é‡‡é›†é—´éš”ï¼š{{ interval }} åˆ†é’Ÿ</div>
    <a class="ghost-btn" href="/">ğŸ  è¿”å›å‰å°</a>
    <a class="ghost-btn" href="/logout">ğŸšª é€€å‡ºç™»å½•</a>
  </div>
</div>

<div class="stat-grid">
  <div class="stat-card">
    <div class="label">ğŸ‘¤ é‡‡é›†è´¦å·</div>
    <div class="value">{{ accounts|length }}</div>
    <span class="stat-hint">ç™»å½• Instagram çš„æœºå™¨äººè´¦å·</span>
  </div>
  <div class="stat-card">
    <div class="label">ğŸ¯ ç›®æ ‡ç”¨æˆ·</div>
    <div class="value">{{ users|length }}</div>
    <span class="stat-hint">å½“å‰æ­£åœ¨è·Ÿè¸ªçš„ç”¨æˆ·</span>
  </div>
  <div class="stat-card">
    <div class="label">âš™ï¸ è®¡åˆ’ä»»åŠ¡</div>
    <div class="value">{{ jobs|length }}</div>
    <span class="stat-hint">APScheduler é˜Ÿåˆ—</span>
  </div>
  <div class="stat-card">
    <div class="label">â° é‡‡é›†é¢‘ç‡</div>
    <div class="value">{{ interval }}m</div>
    <span class="stat-hint">åˆ†é’Ÿä¸ºå•ä½</span>
  </div>
</div>

{% if error %}
<div class="alert">{{ error }}</div>
{% endif %}

<div class="panel-grid">
  <div class="panel">
    <div class="panel-head">
      <div>
        <p class="panel-title">â• æ–°å¢é‡‡é›†è´¦å·</p>
        <p class="panel-sub">é…ç½®ç™»å½•å‡­æ®ä¸ä»£ç†</p>
      </div>
    </div>
    <form method="post" action="/admin/add_account" class="form">
      <div class="form-inline">
        <label>ç”¨æˆ·å
          <input name="username" required placeholder="è¯·è¾“å…¥ Instagram è´¦å·">
        </label>
        <label>å¯†ç 
          <input name="password" type="password" required placeholder="è´¦å·å¯†ç ">
        </label>
      </div>
      <label>ä»£ç† <span class="muted">(å¯é€‰)</span>
        <input name="proxy" placeholder="http://user:pass@host:port">
      </label>
      <label>TOTP å¯†é’¥ <span class="muted">(å¯é€‰)</span>
        <input name="totp_secret" placeholder="ç»‘å®šåŒå› ç´ éªŒè¯ç æ—¶ä½¿ç”¨">
      </label>
      <button type="submit">ğŸ’¾ ä¿å­˜è´¦å·</button>
    </form>
  </div>

  <div class="panel">
    <div class="panel-head">
      <div>
        <p class="panel-title">ğŸ¯ æ–°å¢ç›®æ ‡ç”¨æˆ·</p>
        <p class="panel-sub">å¯é€‰æ‹©ç«‹å³é‡‡é›†ä¸€æ¬¡</p>
      </div>
    </div>
    <form method="post" action="/admin/add_user" class="form">
      <label>ç”¨æˆ·å
        <input name="username" required placeholder="ç›®æ ‡ç”¨æˆ·å">
      </label>
      <label class="inline">
        <input type="checkbox" name="immediate_collect" value="1"> âš¡ ç«‹å³é‡‡é›†ä¸€è½®
      </label>
      <button type="submit">ğŸ’¾ ä¿å­˜ç›®æ ‡</button>
    </form>
  </div>

  <div class="panel">
    <div class="panel-head">
      <div>
        <p class="panel-title">â±ï¸ é‡‡é›†å‘¨æœŸ</p>
        <p class="panel-sub">çµæ´»è°ƒæ•´ä»»åŠ¡é¢‘ç‡</p>
      </div>
    </div>
    <form method="post" action="/admin/set_interval" class="form">
      <label>é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        <input name="minutes" type="number" min="1" value="{{ interval }}">
      </label>
      <button type="submit">ğŸ”„ æ›´æ–°å‘¨æœŸ</button>
    </form>
  </div>
</div>

<div class="panel">
  <div class="panel-head">
    <div>
      <p class="panel-title">ğŸ“‹ è´¦å·åˆ—è¡¨</p>
      <p class="panel-sub">å·²ä¿å­˜çš„é‡‡é›†è´¦å·ä¸ä»£ç†</p>
    </div>
  </div>
  <div class="table wide accounts">
    <div class="thead"><span>è´¦å·</span><span>çŠ¶æ€</span><span>ä»£ç†</span><span>æ“ä½œ</span></div>
    {% for a in accounts %}
    <div class="row">
      <span>{{ a.username }}</span>
      <span class="status" title="{{ a.status_detail or '' }}">{{ a.status }}</span>
      <span>{{ a.proxy or 'ğŸ”— ç›´è¿' }}</span>
      <span class="actions">
        <form method="post" action="/admin/remove_account">
          <input type="hidden" name="account_id" value="{{ a.id }}">
          <button type="submit" class="danger">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
      </span>
    </div>
    {% endfor %}
  </div>
</div>

<div class="panel">
  <div class="panel-head">
    <div>
      <p class="panel-title">ğŸ’¬ æœ€æ–°ç•™è¨€</p>
      <p class="panel-sub">æœ€è¿‘ 20 æ¡ç•™è¨€ï¼Œç‚¹å‡»é‚®ç®±å¯å›å¤</p>
    </div>
  </div>
  {% if messages %}
  <div class="table wide messages">
    <div class="thead"><span>æ—¶é—´</span><span>æ˜µç§°</span><span>é‚®ç®±</span><span>å†…å®¹</span></div>
    {% for msg in messages %}
    <div class="row">
      <span>{{ msg.created_at.strftime('%Y-%m-%d %H:%M') if msg.created_at else '' }}</span>
      <span>{{ msg.name }}</span>
      <span><a href="mailto:{{ msg.email }}">{{ msg.email }}</a></span>
      <span class="muted">{{ msg.content|truncate(80) }}</span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="muted" style="padding: 16px 0;">æš‚æ— ç•™è¨€</div>
  {% endif %}
</div>

<div class="panel">
  <div class="panel-head">
    <div>
      <p class="panel-title">ğŸ“ˆ é‡‡é›†æ–°å¢è¶‹åŠ¿</p>
      <p class="panel-sub">æ¯æ—¥æ–°å¢é‡‡é›†æ•°é‡è¶‹åŠ¿</p>
    </div>
    <div class="chart-meta">
      <span class="muted">å³°å€¼ï¼š{{ stats_max }}</span>
      {% if user_filter %}
      <span class="badge">ç”¨æˆ·ï¼š@{{ user_filter }}</span>
      {% else %}
      <span class="badge">å…¨éƒ¨ç”¨æˆ·</span>
      {% endif %}
    </div>
  </div>
  <form method="get" action="/admin" class="chart-filter">
    <label>èŒƒå›´
      <select name="range">
        <option value="7" {% if range_days == 7 %}selected{% endif %}>7 å¤©</option>
        <option value="30" {% if range_days == 30 %}selected{% endif %}>30 å¤©</option>
        <option value="90" {% if range_days == 90 %}selected{% endif %}>90 å¤©</option>
      </select>
    </label>
    <label>ç”¨æˆ·
      <select name="user">
        <option value="">å…¨éƒ¨</option>
        {% for u in users %}
        <option value="{{ u.username }}" {% if user_filter == u.username %}selected{% endif %}>@{{ u.username }}</option>
        {% endfor %}
      </select>
    </label>
    <button type="submit">ç­›é€‰</button>
  </form>
  {% if stats_max %}
  <div class="chart">
    <svg viewBox="0 0 100 60" preserveAspectRatio="none" class="chart-svg">
      <defs>
        <linearGradient id="chartFill" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.35" />
          <stop offset="100%" stop-color="var(--accent)" stop-opacity="0.05" />
        </linearGradient>
      </defs>
      <polyline points="{{ chart_polyline }}" fill="none" stroke="var(--accent)" stroke-width="1.8" />
      <polygon points="{{ chart_area }}" fill="url(#chartFill)" />
      {% for point in chart_points %}
      <circle cx="{{ point.x }}" cy="{{ point.y }}" r="1.4" fill="var(--accent)">
        <title>{{ point.day }} Â· {{ point.count }}</title>
      </circle>
      {% endfor %}
    </svg>
    <div class="chart-axis">
      <span>{{ stats[0].day if stats else '' }}</span>
      <span>æœ€è¿‘ {{ range_days }} å¤©</span>
      <span>{{ stats[-1].day if stats else '' }}</span>
    </div>
  </div>
  {% else %}
  <div class="muted" style="padding: 16px 0;">æš‚æ— é‡‡é›†æ•°æ®</div>
  {% endif %}
</div>

<div class="panel">
  <div class="panel-head">
    <div>
      <p class="panel-title">ğŸ‘¥ ç›®æ ‡ç”¨æˆ·</p>
      <p class="panel-sub">çŠ¶æ€ä¸ç®¡ç†</p>
    </div>
  </div>
  <div class="table wide targets">
    <div class="thead"><span>ç”¨æˆ·å</span><span>çŠ¶æ€</span><span>æ“ä½œ</span></div>
    {% for u in users %}
    <div class="row">
      <span>{{ u.username }}</span>
      <span>{{ 'âœ… æ´»è·ƒ' if u.is_active else 'â¸ï¸ åœç”¨' }}</span>
      <span class="actions">
        <form method="post" action="/admin/remove_user">
          <input type="hidden" name="user_id" value="{{ u.id }}">
          <button type="submit" class="danger">ğŸ—‘ï¸ åˆ é™¤</button>
        </form>
      </span>
    </div>
    {% endfor %}
  </div>
</div>

<div class="panel">
  <div class="panel-head">
    <div>
      <p class="panel-title">ğŸ“¸ é‡‡é›†åª’ä½“åˆ—è¡¨</p>
      <p class="panel-sub">æ¯é¡µæœ€å¤šæ˜¾ç¤º 20 æ¡</p>
    </div>
    <div class="pagination">
      {% if has_prev %}
        <a href="/admin?page={{ page - 1 }}{{ query_suffix }}">ä¸Šä¸€é¡µ</a>
      {% endif %}
      <span>ç¬¬ {{ page }} / {{ total_pages }} é¡µ</span>
      {% if has_next %}
        <a href="/admin?page={{ page + 1 }}{{ query_suffix }}">ä¸‹ä¸€é¡µ</a>
      {% endif %}
    </div>
  </div>
  {% if medias %}
  <div class="table wide medias">
    <div class="thead">
      <span>ID</span>
      <span>ç”¨æˆ·</span>
      <span>ç±»å‹</span>
      <span>æ—¶é—´</span>
      <span>äº’åŠ¨</span>
      <span>æè¿°</span>
      <span>è¯¦æƒ…</span>
    </div>
    {% for m in medias %}
    <div class="row">
      <span>#{{ m.id }}</span>
      <span>@{{ m.username }}</span>
      <span>{{ m.media_type or '-' }}</span>
      <span>{{ m.taken_at[:10] if m.taken_at else '-' }}</span>
      <span>â¤ï¸ {{ m.likes }} Â· ğŸ’¬ {{ m.comments }}</span>
      <span class="muted">{{ m.caption|truncate(80) }}</span>
      <span><a href="{{ m.detail_url }}">æŸ¥çœ‹</a></span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="muted" style="padding: 20px 0;">æš‚æ— é‡‡é›†æ•°æ®</div>
  {% endif %}
  <div class="pagination pagination-bottom">
    {% if has_prev %}
      <a href="/admin?page={{ page - 1 }}{{ query_suffix }}">ä¸Šä¸€é¡µ</a>
    {% endif %}
    <span>ç¬¬ {{ page }} / {{ total_pages }} é¡µ</span>
    {% if has_next %}
      <a href="/admin?page={{ page + 1 }}{{ query_suffix }}">ä¸‹ä¸€é¡µ</a>
    {% endif %}
  </div>
</div>

<div class="panel">
  <div class="panel-head">
    <div>
      <p class="panel-title">ğŸ“… è®¡åˆ’ä»»åŠ¡</p>
      <p class="panel-sub">å½“å‰è°ƒåº¦é˜Ÿåˆ—</p>
    </div>
  </div>
  <div class="table wide jobs">
    <div class="thead"><span>ID</span><span>ä¸‹æ¬¡è¿è¡Œ</span><span>è§¦å‘å™¨</span></div>
    {% for j in jobs %}
    <div class="row">
      <span>{{ j.id }}</span>
      <span>{{ j.next_run_time }}</span>
      <span class="muted">{{ j.trigger }}</span>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
